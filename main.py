import csv
import os
from files import Files
from report import PenTestReport


def retrieve_csv(filename):
    with open(filename) as file:
        vuln = csv.reader(file, delimiter=',')
        vuln_dict = {}
        for index,item in enumerate(vuln): 
            if index != 0:
                vuln_dict[item[1]] = item[2:]
        return vuln_dict



def retrieve_txt(filename):
    with open(filename) as file:
        content = [item.replace('\n', '').strip() for index,item in enumerate(file.readlines())]
    
    return content


## Create function that find and retrieves the wanted vulnerabilties from the register 

def get_vuln(dict, list):
    vuln_dict = {}
    for i in list: 
        if i in dict:
            vuln_dict[i] = dict[i]
    return vuln_dict


def main():
    os.system('clear')

    print(r"""
          
        __________                                    __   
        \______   \ ____   ____ ______   ____________/  |_ 
        |     ___// __ \ /    \\____ \ /  _ \_  __ \   __\
        |    |   \  ___/|   |  \  |_> >  <_> )  | \/|  |  
        |____|    \___  >___|  /   __/ \____/|__|   |__|  
                    \/     \/|__|                       

        """)
    
    files_obj = Files()

    while True:

        print("\nPlease select the following options:")
        print("        v - view files in current directory")
        print("        u1 - upload vulnerability register")
        print("        u2 - upload vulnerabilities found")
        print("        g - Generate report")
        print("        x - exit")

        choice = input("Enter your choice: ").strip().lower()

        if choice == 'v':
            print('')
            files_obj.files()

        elif choice == 'u1':
            files_obj.upload_vulnerability_register()
            if files_obj.vulnerabilitiy_register != "":
                vuln_dict = retrieve_csv(files_obj.vulnerabilitiy_register)


        elif choice == 'u2':
            files_obj.upload_vulnerabilities_found()
            if files_obj.vulnerabilities_found != "":
                vuln_found = retrieve_txt(files_obj.vulnerabilities_found)


        elif choice == 'g':
            
            report = PenTestReport(
                    title= input("Please input your desired title\n"),
                    company_name=input("What is your company name?\n"),
                    client_name=input("What is your clients name?"),
                    version=input("What is the version number?\n"),
                    engagement_start_date=input("What was the start date for the engagements?\n"),
                    engagement_end_date=input("What was the end date for the engagements?\n"),
                    vulnerabilities=get_vuln(vuln_dict,vuln_found)
                )
            report.create_report()
            print("Your report has been created")

        elif choice == 'x':
            print("Exiting the program.")
            break

        else:
            print("Invalid choice. Please select a valid option.")
        
        



if __name__ == "__main__":
    main()


